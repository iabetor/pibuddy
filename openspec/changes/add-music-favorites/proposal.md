# Proposal: 音乐收藏歌单

## 变更概述

添加音乐收藏功能，用户可以将喜欢的歌曲收藏到个人歌单，通过语音指令播放收藏的歌曲。不同用户的歌单分开存储，支持声纹识别区分用户。

## 动机

- **个性化体验**：每个用户有自己的收藏歌单，互不干扰
- **便捷操作**：播放中一句话即可收藏，无需手动操作手机
- **快速播放**：直接播放收藏的歌曲，无需每次搜索
- **家庭友好**：不同家庭成员各有自己的歌单

## 详细设计

### 功能列表

| 功能 | 语音指令示例 | 说明 |
|------|-------------|------|
| 收藏歌曲 | "收藏这首歌"、"我喜欢这首歌" | 收藏当前播放的歌曲 |
| 播放收藏 | "播放我的收藏"、"播放我喜欢的歌" | 随机播放收藏的歌 |
| 顺序播放 | "顺序播放我的收藏" | 按收藏时间顺序播放 |
| 列出收藏 | "我收藏了哪些歌" | 列出收藏列表 |
| 删除收藏 | "把这首歌从收藏删掉" | 删除收藏 |

### 用户识别逻辑

```
声纹识别 → 识别成功 → 使用用户个人歌单
         → 识别失败 → 使用默认歌单（guest）
```

### 使用示例

```
[播放中]
用户: "收藏这首歌"
助手: "已将《起风了》添加到你的收藏"

用户: "我喜欢这首歌"
助手: "已收藏《晴天》"

用户: "播放我的收藏"
助手: "正在播放你的收藏歌单，共5首歌"
      [随机播放]

用户: "顺序播放我的收藏"
助手: "好的，按顺序播放你的收藏"
      [从第一首开始]

用户: "我收藏了哪些歌"
助手: "你收藏了5首歌：起风了、晴天、稻香、告白气球、七里香"

用户: "把这首歌从收藏删掉"
助手: "已将《晴天》从收藏中删除"
```

### 存储设计

```
{data_dir}/favorites/
├── guest.json      # 默认歌单（未识别用户）
├── 主人.json        # 主人的收藏
├── 小明.json        # 小明的收藏
└── ...
```

文件格式：
```json
{
  "user_name": "主人",
  "songs": [
    {
      "id": "song_123",
      "name": "起风了",
      "artist": "买辣椒也用券",
      "album": "起风了",
      "provider": "netease",
      "added_at": "2026-02-20T15:30:00Z"
    }
  ],
  "updated_at": "2026-02-20T15:30:00Z"
}
```

### 播放逻辑

**随机播放**：
1. 加载用户收藏列表
2. Fisher-Yates 洗牌算法打乱顺序
3. 依次播放

**顺序播放**：
1. 加载用户收藏列表（按 added_at 排序）
2. 从第一首开始依次播放

### 与现有系统的集成

| 组件 | 集成方式 |
|------|---------|
| 声纹识别 | 通过 VoiceprintManager 获取当前用户 |
| 音乐播放器 | 复用现有 Playlist 和 Provider |
| 播放历史 | 收藏的歌曲也会记录到播放历史 |

## 技术方案

详见 [design.md](./design.md)

### 核心组件

1. **FavoritesStore** - 收藏存储管理
2. **AddFavoriteTool** - 收藏歌曲工具
3. **PlayFavoritesTool** - 播放收藏工具
4. **ListFavoritesTool** - 列出收藏工具
5. **RemoveFavoriteTool** - 删除收藏工具

### 关键接口

```go
type FavoritesStore interface {
    Add(userName string, song SongInfo) error
    Remove(userName string, songID string) error
    List(userName string) ([]SongInfo, error)
    Shuffle(userName string) ([]SongInfo, error)
}
```

## 配置

无需额外配置，复用现有 `tools.data_dir` 作为存储根目录。

## 实现任务

详见 [tasks.md](./tasks.md)

## 影响范围

| 文件 | 变更 |
|------|------|
| `internal/music/favorites.go` | 新增 |
| `internal/tools/favorites.go` | 新增 |
| `internal/pipeline/pipeline.go` | 注册工具 |
| `internal/pipeline/state.go` | 传递当前播放歌曲信息 |

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 声纹识别失败 | 中 | 使用默认歌单 |
| 收藏文件损坏 | 低 | 自动重建空歌单 |
| 收藏为空 | 低 | 提示用户先收藏歌曲 |
| 歌曲下架 | 中 | 跳过无效歌曲，提示用户 |

## 后续扩展

- [ ] 收藏歌单同步到云端
- [ ] 分享收藏歌单给其他用户
- [ ] 收藏歌曲的相似推荐
- [ ] 收藏统计（最常播放的收藏）
