# Tasks: 优化 TTS 成本和回复流畅度

## 1. 优化 System Prompt

- [x] 1.1 修改 `configs/pibuddy.yaml` 的 system_prompt
  - 添加"直接调用工具，不要铺垫"的指示
  - 强调"回复连贯完整，避免分段过多"
  - 保持友好性和简洁性的平衡
- [ ] 1.2 测试基础场景
  - 天气查询
  - 黄历查询（农历、宜忌）
  - 时间日期查询
  - 计算器
- [ ] 1.3 测试复杂场景
  - 音乐播放（搜索 + 确认 + 播放）
  - 闹钟设置
  - 备忘录
- [ ] 1.4 测试闲聊场景
  - 讲故事
  - 回答问题
  - 普通对话

## 2. 代码优化

- [x] 2.1 丢弃工具调用前的前言文本
  - 修改 `processQuery` 在检测到 tool_calls 时丢弃 `sentenceBuf` 中的文本
  - 日志记录被丢弃的前言文本
- [x] 2.2 工具调用后回复的缓冲策略
  - 添加 `isPostToolResponse` 标识区分首轮和后续轮
  - 后续轮（工具执行后）缓冲完整回复后再 TTS
  - 添加 `splitIntoSentences` 辅助函数
- [ ] 2.3 测试验证

## 3. 效果评估

- [ ] 3.1 统计 TTS 调用次数变化
- [ ] 3.2 评估回复流畅度（主观感受）
- [ ] 3.3 记录响应时间变化
- [ ] 3.4 收集用户体验反馈

## 实现说明

### 核心改动

1. **前言文本丢弃**: 当 LLM 在调用工具前输出文本（如"我来帮你查询..."），检测到工具调用后直接丢弃，避免无意义的 TTS 合成

2. **缓冲策略**: 
   - 首轮回复（无工具调用）：立即逐句 TTS，保持低延迟
   - 后续轮回复（工具调用后）：缓冲完整内容后再 TTS，减少分段次数

### 预期效果

- 消除"我来帮你查询..."等前言的 TTS 消耗
- 工具调用后的回复更连贯
- TTS 成本降低
