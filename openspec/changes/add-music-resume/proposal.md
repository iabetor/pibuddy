# Proposal: 音乐暂停/恢复播放

## 变更概述

支持音乐播放被打断后恢复播放。当用户在播放音乐过程中唤醒助手执行其他操作后，可以通过"继续播放"指令恢复之前被打断的音乐，从暂停位置继续播放。

## 动机

- **用户体验**：打断后说"继续播放"即可恢复，无需重新搜索
- **避免混淆**：恢复的是之前播放的歌曲，而非搜索同名歌曲
- **无缝体验**：从暂停位置继续，而非从头开始

## 当前问题

```
用户: [正在播放"明天会更好"王菲版]
用户: "你好小派"                    → 打断播放（停止）
用户: "五分钟后提醒我干家务"         → 设置倒计时
用户: "然后继续播放刚才的音乐"       → 重新搜索"明天会更好"
                                      → 播放了"童声版"！❌
```

**问题**：
1. 打断后播放状态丢失（播放列表、当前歌曲、播放位置）
2. "继续播放"变成了重新搜索，可能搜到不同版本

## 详细设计

### 功能设计

| 功能 | 语音指令 | 说明 |
|------|---------|------|
| 暂停 | 唤醒词打断 | 自动暂停当前播放 |
| 恢复 | "继续播放"、"恢复播放" | 从暂停位置继续 |
| 停止 | "停止播放"、"暂停音乐" | 明确停止，不可恢复 |

### 行为对比

| 场景 | 当前行为 | 新行为 |
|------|---------|--------|
| 唤醒打断 | 停止播放，状态丢失 | 暂停播放，保留状态 |
| 说"继续播放" | 重新搜索 | 恢复暂停的歌曲 |
| 播放完毕后说"继续播放" | 无反应 | 提示"播放列表已结束" |

### 使用示例

```
用户: [正在播放"明天会更好"王菲版]
用户: "你好小派"                    → 暂停播放
助手: "我在"
用户: "五分钟后提醒我干家务"         → 设置倒计时
助手: "好的，五分钟后提醒你干家务"
用户: "继续播放"                    → 恢复播放
助手: [继续播放"明天会更好"王菲版，从暂停位置继续]
```

```
用户: [正在播放歌单]
用户: "你好小派"
助手: "我在"
用户: "下一首"                      → 跳到下一首（暂停状态）
助手: "好的"
用户: "继续播放"                    → 播放下一首
助手: [播放下一首歌]
```

### 状态设计

```go
// Pipeline 新增字段
type Pipeline struct {
    // ...
    pausedMusic *PausedMusicInfo  // 暂停的音乐信息
}

type PausedMusicInfo struct {
    Playlist   []PlaylistItem  // 播放列表快照
    Index      int              // 当前播放索引
    Position   time.Duration    // 暂停位置（可选）
    Mode       PlayMode         // 播放模式
}
```

### 恢复逻辑

```
用户说"继续播放"
    ↓
检查是否有暂停的音乐？
    ↓ 是
检查暂停的歌曲是否仍可播放？
    ↓ 是
从暂停位置恢复播放
```

### 与"暂停音乐"工具的区别

| 工具 | 行为 | 可恢复 |
|------|------|--------|
| 唤醒打断 | 自动暂停 | ✅ 可通过"继续播放"恢复 |
| "暂停音乐"指令 | 明确停止 | ❌ 不保存状态，需重新播放 |
| "停止播放"指令 | 明确停止 | ❌ 同上 |

## 技术方案

详见 [design.md](./design.md)

### 核心改动

1. **StreamPlayer** - 添加 `Pause()` 方法（保留缓冲区）
2. **Pipeline** - 打断时保存播放状态到 `pausedMusic`
3. **ResumeMusicTool** - 新工具，恢复暂停的音乐

### 关键接口

```go
// StreamPlayer 新增方法
func (p *StreamPlayer) Pause()
func (p *StreamPlayer) Resume() error
func (p *StreamPlayer) IsPaused() bool
```

## 配置

无需额外配置。

## 实现任务

详见 [tasks.md](./tasks.md)

## 影响范围

| 文件 | 变更 |
|------|------|
| `internal/audio/stream_player.go` | 添加 Pause/Resume 方法 |
| `internal/pipeline/pipeline.go` | 打断逻辑改为暂停 |
| `internal/tools/music.go` | 新增 ResumeMusicTool |
| `internal/pipeline/pipeline.go` | 注册工具 |

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 暂停时间过长，歌曲URL过期 | 中 | 恢复时重新获取URL |
| 播放模式丢失 | 低 | 保存播放模式到暂停状态 |
| 多次打断状态混乱 | 低 | 只保留最后一次暂停状态 |

## 后续扩展

- [x] 保存播放位置（精确到秒）
- [ ] 从指定位置恢复播放（仅限缓存文件）
- [ ] 支持多级暂停（暂停历史）
- [ ] 与收藏功能联动（自动收藏暂停的歌曲）

---

## 追加需求：从指定位置恢复播放

### 背景

用户反馈：打断后恢复播放总是从头开始，希望能从中断位置继续播放。

### 新增需求

| 功能 | 说明 |
|------|------|
| 记录播放位置 | 打断时记录已播放的秒数 |
| 超时检查 | 暂停超过1分钟，放弃位置恢复，从头播放 |
| 从位置恢复 | 如果缓存存在且未超时，从断点位置继续播放 |

### 行为变化

| 场景 | 当前行为 | 新行为 |
|------|---------|--------|
| 打断后立即恢复 | 从头播放 | 从断点位置继续 |
| 打断后超过1分钟恢复 | 从头播放 | 从头播放（提示"已超过X分钟"） |
| 缓存不存在 | 从头播放 | 从头播放（重新下载） |

### 技术要点

1. **记录播放位置**：在 Pipeline 中跟踪歌曲播放的开始时间，打断时计算已播放秒数
2. **位置恢复播放**：StreamPlayer 新增 `PlayFromPosition` 方法，跳过指定秒数后开始播放
3. **仅支持缓存文件**：流式播放难以精确定位，只有本地缓存文件支持位置恢复
