## ADDED Requirements

### Requirement: 用户声纹注册
系统 SHALL 支持通过语音采样注册新用户并建立声纹模型。

#### Scenario: 成功注册新用户
- **WHEN** 管理员执行注册命令并提供 3 个以上有效语音样本
- **THEN** 系统提取声纹特征并存储用户信息
- **AND** 返回注册成功消息

#### Scenario: 样本不足拒绝注册
- **WHEN** 提供的语音样本少于 3 个
- **THEN** 系统返回错误提示要求更多样本
- **AND** 不创建用户记录

#### Scenario: 重复用户 ID 拒绝注册
- **WHEN** 注册的用户 ID 已存在
- **THEN** 系统返回错误提示用户已存在
- **AND** 建议使用不同的用户 ID

### Requirement: 实时身份识别
系统 SHALL 在每次对话开始时通过声纹识别用户身份。

#### Scenario: 识别已注册用户
- **WHEN** 唤醒后采集 3 秒音频
- **THEN** 系统提取声纹特征并与数据库匹配
- **AND** 相似度超过阈值(默认 0.75)时返回用户 ID
- **AND** 设置用户上下文用于后续对话

#### Scenario: 未识别用户降级为访客模式
- **WHEN** 声纹特征与所有已注册用户相似度均低于阈值
- **THEN** 系统返回 "guest" 用户 ID
- **AND** 启用访客模式对话(通用设置,无个性化)

#### Scenario: 识别服务超时降级
- **WHEN** 声纹识别服务响应超过 3 秒
- **THEN** Go 客户端超时并返回 "guest"
- **AND** 记录警告日志
- **AND** 不阻塞主对话流程

### Requirement: 用户管理
系统 SHALL 提供用户管理工具支持增删查操作。

#### Scenario: 列出所有已注册用户
- **WHEN** 管理员执行列表命令
- **THEN** 系统显示所有用户 ID 和注册时间
- **AND** 显示样本数量和模型状态

#### Scenario: 删除已注册用户
- **WHEN** 管理员执行删除命令并指定用户 ID
- **THEN** 系统删除用户数据和声纹模型
- **AND** 返回删除成功消息

#### Scenario: 删除不存在的用户
- **WHEN** 指定的用户 ID 不存在
- **THEN** 系统返回错误提示用户未找到

### Requirement: 声纹服务可用性
系统 SHALL 通过 gRPC 与声纹识别服务通信并处理服务异常。

#### Scenario: 服务正常响应
- **WHEN** Go 客户端发起识别请求
- **THEN** Python 服务在 3 秒内返回识别结果
- **AND** 客户端解析响应并设置用户上下文

#### Scenario: 服务不可用时降级
- **WHEN** 声纹服务未启动或网络不可达
- **THEN** Go 客户端连接失败后立即降级为访客模式
- **AND** 记录错误日志但不抛出异常
- **AND** 主程序继续正常运行

#### Scenario: 服务崩溃自动恢复
- **WHEN** Python 服务因异常退出
- **THEN** systemd 自动重启服务
- **AND** Go 客户端下次请求时重新连接

### Requirement: 性能约束
系统 SHALL 满足以下性能指标以保证用户体验。

#### Scenario: 识别延迟符合要求
- **WHEN** 在树莓派 4B 上进行声纹识别
- **THEN** 从音频采集到返回结果耗时 < 3 秒
- **AND** 不影响唤醒后的响应速度感知

#### Scenario: 内存占用可接受
- **WHEN** 声纹服务运行中
- **THEN** Python 进程内存占用 < 500MB
- **AND** Go 主程序内存增加 < 50MB

#### Scenario: 识别准确率符合预期
- **WHEN** 使用 5 个以上用户测试
- **THEN** 正确识别率 > 85%
- **AND** 误识别率 < 5%
