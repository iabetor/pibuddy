## Context

PiBuddy 当前使用 Edge TTS 作为语音合成引擎，但在中国大陆网络环境下经常出现 WebSocket 连接失败。同时，唤醒词检测存在配置格式问题导致无法正常启动。

**约束条件**:
- 需要在国内网络环境下稳定运行
- 保持现有的 `Engine` 接口不变
- 用户需要配置腾讯云 API 密钥

**利益相关者**:
- 国内用户（主要目标群体）
- 树莓派部署用户

## Goals / Non-Goals

**Goals**:
- 实现国内可用的 TTS 方案
- 修复唤醒词检测配置问题
- 优化用户体验（更长的反应时间）

**Non-Goals**:
- 不实现流式 TTS（腾讯云 SDK 不直接支持）
- 不移除 Edge TTS 和 Piper TTS（保留作为备选）
- 不修改音频播放逻辑

## Decisions

### D1: 选择腾讯云 TTS 而非其他国内方案

**决定**: 使用腾讯云 TTS

**理由**:
| 方案 | 优点 | 缺点 |
|------|------|------|
| 腾讯云 TTS | Go SDK 成熟、免费额度充足、质量好 | 需要 API Key |
| 阿里云 TTS | 质量好 | SDK 接入复杂度相当 |
| 讯飞 TTS | 中文效果最好 | SDK 接入复杂、免费额度少 |
| macOS say | 零配置 | 仅 macOS 可用，不符合树莓派目标 |

**结论**: 腾讯云 TTS 综合最优，Go SDK 支持完善。

### D2: 使用 KeywordsFile 而非 KeywordsBuf

**决定**: 使用 `KeywordsFile` 字段指定关键词文件路径

**理由**:
- sherpa-onnx 关键词需要经过 `text2token` 工具处理为拼音格式
- 使用文件路径更清晰，便于用户理解和维护
- 避免在配置文件中嵌入复杂的拼音格式字符串

### D3: VAD 静音检测时间调整

**决定**: 将 `min_silence_ms` 从 500ms 调整为 1200ms

**理由**:
- 500ms 过短，用户说完唤醒词后需要立即说话
- 1200ms 给用户约 1 秒的反应时间开始说话
- 不会过长导致明显延迟

## Risks / Trade-offs

| 风险 | 缓解措施 |
|------|----------|
| 腾讯云 API 调用失败 | 保留 Edge/Piper 作为备选引擎 |
| 用户未配置密钥 | 启动时检查并给出清晰错误提示 |
| 腾讯云费用 | 免费额度每月 100 万字符足够个人使用 |

## Migration Plan

1. **配置更新**: 用户需要更新 `configs/pibuddy.yaml`
2. **环境变量**: 设置腾讯云 API 密钥
3. **关键词文件**: 运行脚本生成 `keywords.txt`

**回滚**: 如需回退，可将 `tts.engine` 改回 `edge` 或 `piper`

## Open Questions

- [ ] 是否需要在启动时自动检测网络环境选择 TTS 引擎？
- [ ] 腾讯云 TTS 返回的音频格式选择（mp3 vs pcm）？
